// Datenpunkte-Definitionen mit Namen auf Deutsch
itemLabels = {

"q13_a" : "interne Zelle ",
"q13_b" : "extern1 Zelle ",
"q13_c" : "extern2 Zelle ",
  
"q15_pe": "Batterieprozentsatz",
"q15_vv": "Geräteversionsnummer",
"q15_sv": "Subversion",
"q15_cs": "Ladeeinstellungen",
"q15_cd": "Entladeeinstellungen",
"q15_am": "AM",
"q15_do": "Entladetiefe (DoD)",
"q15_lv": "Batterieentladeschwelle",
"q15_cj": "Szene",
"q15_kn": "Batteriekapazität",
"q15_b1": "Power Pack 1 verbunden",
"q15_b2": "Power Pack 2 verbunden",
"q15_tl": "Mindesttemperatur der Batteriezellen",
"q15_th": "Höchsttemperatur der Batteriezellen",
"q15_tc": "Ladetemperaturalarm",
"q15_tf": "Entladetemperaturalarm",
"q15_fc": "Chip FC4 Versionsnummer",
"q15_id": "ID",
"q15_a0": "Powerpack 0 %",
"q15_a1": "Powerpack 1 %",
"q15_a2": "Powerpack 2 %",
"q15_l0": "L0",
"q15_l1": "L1",
"q15_ws": "QUERY 15 - WS",
"q15_r3": "QUERY 15 - R3",
"q15_r4": "QUERY 15 - R4",
"q15_r5": "QUERY 15 - R5",  

"q16_p1": "Solar-Eingangsstatus 1",
"q16_p2": "Solar-Eingangsstatus 2",
"q16_m1": "QUERY 16 - M1",
"q16_m2": "QUERY 16 - M2",
"q16_w1": "Solar-Eingangsleistung 1",
"q16_w2": "Solar-Eingangsleistung 2",
"q16_e1": "QUERY 16 - E1",
"q16_e2": "QUERY 16 - E2",
"q16_o1": "Ausgangszustand 1",
"q16_o2": "Ausgangszustand 2",
"q16_g1": "Ausgangsleistung 1",
"q16_g2": "Ausgangsleistung 2",

// my calc / adds
"q13__a_min" : "intern - Minimum Voltage",
"q13__a_max" : "intern - Maximimum Voltage",  
"q13__a_avg" : "intern - Average Voltage",  
"q13__a_total" : "intern - Total Voltage",    
"q13__a_drift" : "intern - Drift Voltage",  
"q13__b_min" : "extern1 - Minimum Voltage",
"q13__b_max" : "extern1 - Maximimum Voltage",  
"q13__b_avg" : "extern1 - Average Voltage", 
"q13__b_total" : "extern1 - Total Voltage",    
"q13__b_drift" : "extern1 - Drift Voltage",  
"q13__c_min" : "extern2 - Minimum Voltage",
"q13__c_max" : "extern2 - Maximimum Voltage",  
"q13__c_avg" : "extern2 - Average Voltage", 
"q13__c_total" : "extern2 - Total Voltage",  
"q13__c_drift" : "extern2 - Drift Voltage",  

"q15__l0_3": "L0: intern - Undervoltage",
"q15__l0_2": "L0: intern - DOD",  
"q15__l0_1": "L0: intern - Laden",
"q15__l0_0": "L0: intern - Entladen",
  
"q15__l1_7": "L1: extern1 - Undervoltage",
"q15__l1_6": "L1: extern1 - DOD",    
"q15__l1_5": "L1: extern1 - Laden",
"q15__l1_4": "L1: extern1 - Entladen",
"q15__l1_3": "L1: extern2 - Undervoltage",
"q15__l1_2": "L1: extern2 - DOD",  
"q15__l1_1": "L1: extern2 - Laden",  
"q15__l1_0": "L1: extern2 - Entladen",
  
"q15__r3_7": "SSR1 - WDT - Watchdog Overflow",
"q15__r3_6": "SSR1 - PF - Overvoltage protection 2",
"q15__r3_5": "SSR1 - SC - Short circuit protection",
"q15__r3_4": "SSR1 - OCC - Charge Overcurrent protection",
"q15__r3_3": "SSR1 - OCD2 - Discharge Overcurrent level-1 protection",
"q15__r3_2": "SSR1 - OCD1 - Discharge Overcurrent level-2 protection",
"q15__r3_1": "SSR1 - UV - Undervoltage protection",
"q15__r3_0": "SSR1 - OV - Overvoltage protection",
"q15__r4_7": "SSR2 - 7",
"q15__r4_6": "SSR2 - 6",
"q15__r4_5": "SSR2 - 5",
"q15__r4_4": "SSR2 - 4",
"q15__r4_3": "SSR2 - OTD - Discharge overtemperature protection",
"q15__r4_2": "SSR2 - UTD - Discharge undertemperature protection",
"q15__r4_1": "SSR2 - OTC - Charge overtemperature protection",
"q15__r4_0": "SSR2 - UTC - Charge undertemperature protection",
"q15__r5_7": "SSR3 - CHGING - Charging",
"q15__r5_6": "SSR3 - DSGING - Discharging",
"q15__r5_5": "SSR3 - 5",
"q15__r5_4": "SSR3 - 4",
"q15__r5_3": "SSR3 - SSR3 L0V - Low voltage prohibition charge",
"q15__r5_2": "SSR3 - PCHG_FET - Precharge MOSFET",
"q15__r5_1": "SSR3 - CHG_FET - Charge MOSFET",
"q15__r5_0": "SSR3 - DSG_FET - Discharge MOSFET",

"q16__w3": "Solar Gesamt",
"q16__g3": "Ausgangsleistung gesamt",
  

// FW 216.xx  
"md": "Entlademodus-Einstellung",
"q15_d1": "Zeit 1 Aktivierungsstatus",
"q15_e1": "Zeit 1 Startzeit",
"q15_f1": "Zeit 1 Endzeit",
"q15_h1": "Zeit 1 Ausgangswert",
"q15_d2": "Zeit 2 Aktivierungsstatus",
"q15_e2": "Zeit 2 Startzeit",
"q15_f2": "Zeit 2 Endzeit",
"q15_h2": "Zeit 2 Ausgangswert",
"q15_d3": "Zeit 3 Aktivierungsstatus",
"q15_e3": "Zeit 3 Startzeit",
"q15_f3": "Zeit 3 Endzeit",
"q15_h3": "Zeit 3 Ausgangswert",
  
"q16_sg": "Sensor verbunden",
"q16_sp": "Sensor Ausgang",
"q16_st": "Sensor Messwert",

"q21_cf" : "QUERY 21 - CF",
"q21_df" : "QUERY 21 - DF",

// FW 216.xx
"q15_c0" : "QUERY 16 - C0",
"q15_c1" : "QUERY 16 - C1",
  
"q16_i1" : "QUERY 16 - I1",
"q16_i2" : "QUERY 16 - I2",  

"q14_ds" : "QUERY 14 - DS",
"q14_ps" : "QUERY 14 - PS",
"q14_ch" : "QUERY 14 - CH",
"q14_as" : "QUERY 14 - AS",
"q14_e0" : "QUERY 14 - E0",
"q14_e1" : "QUERY 14 - E1",
"q14_op" : "QUERY 14 - OP",  
"q14_cp" : "QUERY 14 - CP",
"q14_cr" : "QUERY 14 - CR",
"q14_c0" : "QUERY 14 - C0",  
"q14_c1" : "QUERY 14 - C1",  
"q14_c2" : "QUERY 14 - C2", 
  
"q24_id" : "QUERY 24 - ID",
"q24_s" : "QUERY 24 - S",
"q24_c" : "QUERY 24 - C",
"q24_i" : "QUERY 24 - I",
"q24_p" : "QUERY 24 - P", 
  
"last": "Timestamp",
  
};

var q13_c_calcs = [ "a_min", "a_max","a_avg","a_total", "a_drift", "b_min", "b_max","b_avg","b_total", "b_drift", "c_min", "c_max","c_avg","c_total","c_drift"];
// maybe removed reserved: 5_5 / 5_4 / 4_7 / 4_6 / 4_5 / 4_4
var q15_r_bits = [ "r3_7","r3_6","r3_5","r3_4","r3_3","r3_2","r3_1","r3_0","r4_7","r4_6","r4_5","r4_4","r4_3","r4_2","r4_1","r4_0","r5_7","r5_6","r5_5","r5_4","r5_3","r5_2","r5_1","r5_0"];
var q15_l_bits = [ "l0_0", "l0_1","l0_2","l0_3","l1_0","l1_1","l1_2","l1_3","l1_4","l1_5","l1_6","l1_7" ];


function isBitSet(number, pos) {
  return (number & (1 << pos)) === 0 ? 0 : 1;
  //return ((number>>pos) % 2 != 0)
}


//var eventTopic = items.B2500V2__MQTT__intern_B2500V2__MQTT__1__SUB.receivedEvent;
//var eventTopic = this.receivedEvent;
//var eventTopic = receivedEvent.toString;
//console.log("TOPIC: " + eventTopic);

//edit BELOW
var itemParent = "B2500V2__MQTT__intern";
var itemGroup  = "B2500V2__MQTT__intern_B2500V2__MQTT__1__";
var itemLabel  = "B2500V2 - MQTT - 1 - DATA";
//edit END

var itemGroupSUB = itemGroup + "SUB";
var itemGroupDATA = itemGroup + "DATA";

//check for GroupData and add if not exists
if (items.getItem(itemGroupDATA, true) == null) {
  //console.log("Group not found: " + itemGroupDATA);
  items.addItem({name: itemGroupDATA, type: 'Group', label: itemLabel, groups: [itemParent], tags: ['Equipment']});
}

// edit NEXT Line
var data = items.B2500V2__MQTT__intern_B2500V2__MQTT__1__SUB.state;

var response13 = false;
var response14 = false;
var response15 = false;
var response16 = false;
var response21 = false;
var response24 = false;

// check response to select/correct diz ( really dirty ) - 01/15/16 are still mixed 
if (data.startsWith("a0=") == true) { response13 = true; }
if (data.startsWith("ds=") == true) { response14 = true; }
if (data.startsWith("pe=") == true) { response15 = true; }
if (data.startsWith("p1=") == true) { response16 = true; }
if (data.startsWith("cf=") == true) { response21 = true; }
if (data.startsWith("id=") == true) { response24 = true; }

//var data = items.${itemGroupSUB}.state;
var values = data.split(',');

// Q13 - cell stats
var a_min = a_max = a_avg = a_total = a_drift = 0;
var b_min = b_max = b_avg = b_total = b_drift = 0;
var c_min = c_max = c_avg = c_total = c_drift = 0;

// gesamtleistung ein- und ausgange
var w3 = g3 = 0;

// Q15 - RX bits
var r3_7 = r3_6 = r3_5 = r3_4 = r3_3 = r3_2 = r3_1 = r3_0 = 0;
var r4_7 = r4_6 = r4_5 = r4_4 = r4_3 = r4_2 = r4_1 = r4_0 = 0;
var r5_7 = r5_6 = r5_5 = r5_4 = r5_3 = r5_2 = r5_1 = r5_0 = 0;

// Q15 - LX bits
var l0_0 = l0_1 = l0_2 = l0_3 = l1_0 = l1_1 = l1_2 = l1_3 = l1_4 = l1_5 = l1_6 = l1_7 = 0;

values.forEach((value) => {
  const [key, val] = value.split('=');
  //console.log(key + ": " + val);
  var nkey = "";
  var nval = Number(val);
  //quick and dirty fix for double shorts ( cmd 01/13/14/16 have overlapping shorts - needs better separation ( query_short, f.ex. 1_a0 / 13_a0 / 15_a0 ))
  if ( response13 == true ) { nkey = "q13_" + key; }
  if ( response14 == true ) { nkey = "q14_" + key; }
  if ( response15 == true ) { nkey = "q15_" + key; }
  if ( response16 == true ) { nkey = "q16_" + key; }
  if ( response21 == true ) { nkey = "q21_" + key; }
  if ( response24 == true ) { nkey = "q24_" + key; }
  
  var itemName = itemGroupDATA + "_" + nkey;
  var item = items.getItem(itemName, true);

  // zellen
  if ( response13 == true ) {
    if (Number(nval) != 0) {
      
      //console.log(key + ": " + val);
      if (nkey.startsWith("q13_a")) { 
        if ((Number(nval) < Number(a_min)) || (Number(a_min) == 0)) { a_min=Number(nval); }; 
        if (Number(nval) > Number(a_max)) { a_max=Number(nval); }; 
        a_total += Number(nval); 
      }
      if (nkey.startsWith("q13_b")) { 
        if ((Number(nval) < Number(b_min)) || (Number(b_min) == 0)) { b_min=Number(nval); }; 
        if (Number(nval) > Number(b_max)) { b_max=Number(nval); }; 
        b_total += Number(nval); 
      }
      if (nkey.startsWith("q13_c")) { 
        if ((Number(nval) < Number(c_min)) || (Number(c_min) == 0)) { c_min=Number(nval); }; 
        if (Number(nval) > Number(c_max)) { c_max=Number(nval); }; 
        c_total += Number(nval); 
      }
    }
  }

  // Q15 - L-Bits / R-Bits
  if ( response15 == true) {
      if ( nkey === "q15_l0" ) {
        l0_0 = isBitSet(val,0);
        l0_1 = isBitSet(val,1);
        l0_2 = isBitSet(val,2);
        l0_3 = isBitSet(val,3);
      }
      if ( nkey === "q15_l1" ) {
        l1_0 = isBitSet(val,0);
        l1_1 = isBitSet(val,1);
        l1_2 = isBitSet(val,2);
        l1_3 = isBitSet(val,3);
        l1_4 = isBitSet(val,4);
        l1_5 = isBitSet(val,5);
        l1_6 = isBitSet(val,6);
        l1_7 = isBitSet(val,7);
      }
      if ( nkey === "q15_r3" ) {
        r3_0 = isBitSet(val,0);
        r3_1 = isBitSet(val,1);
        r3_2 = isBitSet(val,2);
        r3_3 = isBitSet(val,3);
        r3_4 = isBitSet(val,4);
        r3_5 = isBitSet(val,5);
        r3_6 = isBitSet(val,6);
        r3_7 = isBitSet(val,7);
      }
      if ( nkey === "q15_r4" ) {
        r4_0 = isBitSet(val,0);
        r4_1 = isBitSet(val,1);
        r4_2 = isBitSet(val,2);
        r4_3 = isBitSet(val,3);
        r4_4 = isBitSet(val,4);
        r4_5 = isBitSet(val,5);
        r4_6 = isBitSet(val,6);
        r4_7 = isBitSet(val,7);
      }
      if ( nkey === "q15_r5" ) {
        r5_0 = isBitSet(val,0);
        r5_1 = isBitSet(val,1);
        r5_2 = isBitSet(val,2);
        r5_3 = isBitSet(val,3);
        r5_4 = isBitSet(val,4);
        r5_5 = isBitSet(val,5);
        r5_6 = isBitSet(val,6);
        r5_7 = isBitSet(val,7);
      }
    
    
  }
  // gesamtleistung ein- und ausgange
  if ( response16 == true ) {
    if ( nkey === "q16_w1" || nkey === "q16_w2") { w3 += Number(val); }
    if ( nkey === "q16_g1" || nkey === "q16_g2") { g3 += Number(val); }
  }
  
  // create/update items
  if (item == null) {
    //console.log("Item not found: " + itemName + "(" + itemLabels[key] + ")");
    var itemType = "Number"
    if (nkey === "q15_e1" || nkey === "q15_e2" || nkey === "q15_e3" || nkey === "q15_f1" || nkey === "q15_f2" || nkey === "q15_f3" ) { itemType = "String"; }
    if ( response13 == true ) {
      var Xn = Number("0x" + nkey.slice(-1)) + 1;
      var Xlabel = "";
      if (key.startsWith("a")) { Xlabel = itemLabels["q13_a"] + Xn }
      if (key.startsWith("b")) { Xlabel = itemLabels["q13_b"] + Xn }
      if (key.startsWith("c")) { Xlabel = itemLabels["q13_c"] + Xn }
      items.addItem({name: itemName, type: itemType, label: Xlabel, groups: [itemGroupDATA], tags: ['Point']});
    } else {
      items.addItem({name: itemName, type: itemType, label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
    }
    
  } else {
    item.postUpdate(val);
  }
  

})

// additional/calculated values

// zell-calcs
if ( response13 == true ) {
  q13_c_calcs.forEach((l) => {
      var nkey = "q13__" + l;
      var itemName = itemGroupDATA + "_" + nkey;
      var item = items.getItem(itemName, true);
      if (item == null) {
        items.addItem({name: itemName, type: 'Number', label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
      } else {
        //console.log("---------------- Q13 : min" + a_min + " - " + a_max);
        if (nkey == "q13__a_min") { item.postUpdate(Number(a_min)); }
        if (nkey == "q13__a_max") { item.postUpdate(Number(a_max)); }        
        if (nkey == "q13__a_total") { item.postUpdate(Number(a_total)); }
        if (nkey == "q13__a_avg") { item.postUpdate(Number(a_total) / Number(14)); }
        if (nkey == "q13__a_drift") { item.postUpdate(Number(a_max) - Number(a_min)); }
        if (nkey == "q13__b_min") { item.postUpdate(Number(b_min)); }
        if (nkey == "q13__b_max") { item.postUpdate(Number(b_max)); }        
        if (nkey == "q13__b_total") { item.postUpdate(Number(b_total)); }
        if (nkey == "q13__b_avg") { item.postUpdate(Number(b_total) / Number(14)); }
        if (nkey == "q13__b_drift") { item.postUpdate(Number(b_max) - Number(b_min)); }
        if (nkey == "q13__c_min") { item.postUpdate(c_min); }
        if (nkey == "q13__c_max") { item.postUpdate(c_max); }        
        if (nkey == "q13__c_total") { item.postUpdate(c_total); }
        if (nkey == "q13__c_avg") { item.postUpdate(Number(c_total) / Number(14)); }
        if (nkey == "q13__c_drift") { item.postUpdate(Number(c_max) - Number(c_min)); }
      }
  })
}
                      
// L bit-mask
if ( response15 == true ) {
  q15_l_bits.forEach((l) => {
      var nkey = "q15__" + l;
      var itemName = itemGroupDATA + "_" + nkey;
      var item = items.getItem(itemName, true);
      if (item == null) {
        items.addItem({name: itemName, type: 'Number', label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
      } else {
        if (nkey == "q15__l0_0") { item.postUpdate(l0_0); }
        if (nkey == "q15__l0_1") { item.postUpdate(l0_1); }
        if (nkey == "q15__l0_2") { item.postUpdate(l0_2); }
        if (nkey == "q15__l0_3") { item.postUpdate(l0_3); }
        if (nkey == "q15__l1_0") { item.postUpdate(l1_0); }
        if (nkey == "q15__l1_1") { item.postUpdate(l1_1); }
        if (nkey == "q15__l1_2") { item.postUpdate(l1_2); }
        if (nkey == "q15__l1_3") { item.postUpdate(l1_3); }
        if (nkey == "q15__l1_4") { item.postUpdate(l1_4); }
        if (nkey == "q15__l1_5") { item.postUpdate(l1_5); }
        if (nkey == "q15__l1_6") { item.postUpdate(l1_6); }
        if (nkey == "q15__l1_7") { item.postUpdate(l1_7); }
      }
    }
  )
  q15_r_bits.forEach((r) => {
      var nkey = "q15__" + r;
      var itemName = itemGroupDATA + "_" + nkey;
      var item = items.getItem(itemName, true);
      if (item == null) {
        items.addItem({name: itemName, type: 'Number', label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
      } else {
        if (nkey == "q15__r3_0") { item.postUpdate(r3_0); }
        if (nkey == "q15__r3_1") { item.postUpdate(r3_1); }
        if (nkey == "q15__r3_2") { item.postUpdate(r3_2); }
        if (nkey == "q15__r3_3") { item.postUpdate(r3_3); }
        if (nkey == "q15__r3_4") { item.postUpdate(r3_4); }
        if (nkey == "q15__r3_5") { item.postUpdate(r3_5); }
        if (nkey == "q15__r3_6") { item.postUpdate(r3_6); }
        if (nkey == "q15__r3_7") { item.postUpdate(r3_7); }
        if (nkey == "q15__r4_0") { item.postUpdate(r4_0); }
        if (nkey == "q15__r4_1") { item.postUpdate(r4_1); }
        if (nkey == "q15__r4_2") { item.postUpdate(r4_2); }
        if (nkey == "q15__r4_3") { item.postUpdate(r4_3); }
        if (nkey == "q15__r4_4") { item.postUpdate(r4_4); }
        if (nkey == "q15__r4_5") { item.postUpdate(r4_5); }
        if (nkey == "q15__r4_6") { item.postUpdate(r4_6); }
        if (nkey == "q15__r4_7") { item.postUpdate(r4_7); }
        if (nkey == "q15__r5_0") { item.postUpdate(r5_0); }
        if (nkey == "q15__r5_1") { item.postUpdate(r5_1); }
        if (nkey == "q15__r5_2") { item.postUpdate(r5_2); }
        if (nkey == "q15__r5_3") { item.postUpdate(r5_3); }
        if (nkey == "q15__r5_4") { item.postUpdate(r5_4); }
        if (nkey == "q15__r5_5") { item.postUpdate(r5_5); }
        if (nkey == "q15__r5_6") { item.postUpdate(r5_6); }
        if (nkey == "q15__r5_7") { item.postUpdate(r5_7); }
        
      }
    }
  )
  
  
}

// gesamtleistung eingang
if ( response16 == true ) {
  var nkey = "q16__w3";
  var itemName = itemGroupDATA + "_" + nkey;
  var item = items.getItem(itemName, true);
  if (item == null) {
    items.addItem({name: itemName, type: 'Number', label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
  } else {
    item.postUpdate(w3);
  }
  // gesamtleistung ausgang
  var nkey = "q16__g3"
  var itemName = itemGroupDATA + "_" + nkey;
  var item = items.getItem(itemName, true);
  if (item == null) {
    items.addItem({name: itemName, type: 'Number', label: itemLabels[nkey], groups: [itemGroupDATA], tags: ['Point']});
  } else {
    item.postUpdate(g3);
  }
}  



// timestamp
var key = "last";
var timestamp = time.ZonedDateTime.now().format(time.DateTimeFormatter.ofPattern('dd.MM.yyyy HH:mm:ss'));
//console.log("Timestamp: " + timestamp);
var itemName = itemGroupDATA + "_" + key;
var item = items.getItem(itemName, true);
if (item == null) {
  items.addItem({name: itemName, type: 'String', label: itemLabels[key], groups: [itemGroupDATA], tags: ['Point']});
} else {
  item.postUpdate(timestamp);
}

