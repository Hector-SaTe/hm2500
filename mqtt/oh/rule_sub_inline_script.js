// Datenpunkte-Definitionen mit Namen auf Deutsch
itemLabels = {
"p1" : "Solar-Eingangsstatus 1",
"p2" : "Solar-Eingangsstatus 2",
"w1" : "Solar-Eingangsleistung 1",
"w2" : "Solar-Eingangsleistung 2",
"pe" : "Batterieprozentsatz",
"vv" : "Geräteversionsnummer",
"cs" : "Ladeeinstellungen",
"cd" : "Entladeeinstellungen",
"am" : "AM",
"o1" : "Ausgangszustand 1",
"o2" : "Ausgangszustand 2",
"do" : "Entladetiefe (DoD)",
"lv" : "Batterieentladeschwelle",
"cj" : "Szene",
"kn" : "Batteriekapazität",
"g1" : "Ausgangsleistung 1",
"g2" : "Ausgangsleistung 2",
"b1" : "Power Pack 1 verbunden",
"b2" : "Power Pack 2 verbunden",
"md" : "Entlademodus-Einstellung",
"d1" : "Zeit 1 Aktivierungsstatus",
"e1" : "Zeit 1 Startzeit",
"f1" : "Zeit 1 Endzeit",
"h1" : "Zeit 1 Ausgangswert",
"d2" : "Zeit 2 Aktivierungsstatus",
"e2" : "Zeit 2 Startzeit",
"f2" : "Zeit 2 Endzeit",
"h2" : "Zeit 2 Ausgangswert",
"d3" : "Zeit 3 Aktivierungsstatus",
"e3" : "Zeit 3 Startzeit",
"f3" : "Zeit 3 Endzeit",
"h3" : "Zeit 3 Ausgangswert",
"sg" : "Ist der Sensor verbunden",
"sp" : "Automatische Leistungsgröße des Monitors",
"st" : "Vom Monitor übertragene Leistung",
"tl" : "Mindesttemperatur der Batteriezellen",
"th" : "Höchsttemperatur der Batteriezellen",
"tc" : "Ladetemperaturalarm",
"tf" : "Entladetemperaturalarm",
"ts" : "WiFi-Signalerkennung",
"fc" : "Chip FC4 Versionsnummer",
"id" : "ID",
"a0" : "Powerpack 0 %",
"a1" : "Powerpack 1 %",
"a2" : "Powerpack 2 %",
"l0" : "L0",
"l1" : "L1",
"sv" : "Subversion",
"w3" : "Solar Gesamt",
"g3" : "Ausgangsleistung gesamt",
"last" : "Timestamp",
"c0" : "QUERY 1 - C0",
"c1" : "QUERY 1 - C1",
"ws" : "QUERY 15 - WS",
"r3" : "QUERY 15 - R3",
"r4" : "QUERY 15 - R4",
"r5" : "QUERY 15 - R5",  
"m1" : "QUERY 16 - M1",
"m2" : "QUERY 16 - M2",
"i1" : "QUERY 16 - I1",
"i2" : "QUERY 16 - I2",  
"16_e1" : "QUERY 16 - E1" ,
"16_e2" : "QUERY 16 - E2",
"13_a0" : "intern Zelle 1",
"13_a1" : "intern Zelle 2",
"13_a2" : "intern Zelle 3",
"13_a3" : "intern Zelle 4",
"13_a4" : "intern Zelle 5",
"13_a5" : "intern Zelle 6",
"13_a6" : "intern Zelle 7",
"13_a7" : "intern Zelle 8",
"13_a8" : "intern Zelle 9",
"13_a9" : "intern Zelle 10",
"13_aa" : "intern Zelle 11",
"13_ab" : "intern Zelle 12",
"13_ac" : "intern Zelle 13",
"13_ad" : "intern Zelle 14",
"13_ae" : "intern Zelle 15",
"13_af" : "intern Zelle 16",
"13_b0" : "extern 1 - Zelle 1",
"13_b1" : "extern 1 - Zelle 2",
"13_b2" : "extern 1 - Zelle 3",
"13_b3" : "extern 1 - Zelle 4",
"13_b4" : "extern 1 - Zelle 5",
"13_b5" : "extern 1 - Zelle 6",
"13_b6" : "extern 1 - Zelle 7",
"13_b7" : "extern 1 - Zelle 8",
"13_b8" : "extern 1 - Zelle 9",
"13_b9" : "extern 1 - Zelle 10",
"13_ba" : "extern 1 - Zelle 11",
"13_bb" : "extern 1 - Zelle 12",
"13_bc" : "extern 1 - Zelle 13",
"13_bd" : "extern 1 - Zelle 14",
"13_be" : "extern 1 - Zelle 15",
"13_bf" : "extern 1 - Zelle 16",
"13_c0" : "extern 2 - Zelle 1",
"13_c1" : "extern 2 - Zelle 2",
"13_c2" : "extern 2 - Zelle 3",
"13_c3" : "extern 2 - Zelle 4",
"13_c4" : "extern 2 - Zelle 5",
"13_c5" : "extern 2 - Zelle 6",
"13_c6" : "extern 2 - Zelle 7",
"13_c7" : "extern 2 - Zelle 8",
"13_c8" : "extern 2 - Zelle 9",
"13_c9" : "extern 2 - Zelle 10",
"13_ca" : "extern 2 - Zelle 11",
"13_cb" : "extern 2 - Zelle 12",
"13_cc" : "extern 2 - Zelle 13",
"13_cd" : "extern 2 - Zelle 14",
"13_ce" : "extern 2 - Zelle 15",
"13_cf" : "extern 2 - Zelle 16",
"14_ds" : "QUERY 14 - DS",
"14_ps" : "QUERY 14 - PS",
"14_ch" : "QUERY 14 - CH",
"14_as" : "QUERY 14 - AS",
"14_e0" : "QUERY 14 - E0",
"14_e1" : "QUERY 14 - E1",
"14_op" : "QUERY 14 - OP",  
"14_cp" : "QUERY 14 - CP",
"14_cr" : "QUERY 14 - CR",
"14_c0" : "QUERY 14 - C0",  
"14_c1" : "QUERY 14 - C1",  
"14_c2" : "QUERY 14 - C2", 
"21_cf" : "Query 21 - CF",
"21_df" : "Query 21 - DF", 
"24_id" : "Query 24 - ID",
"24_s" : "QUERY 24 - S",
"24_c" : "QUERY 24 - C",
"24_i" : "QUERY 24 - I",
"24_p" : "QUERY 24 - P", 
};

//var eventTopic = items.B2500V2__MQTT__intern_B2500V2__MQTT__1__SUB.receivedEvent;
//var eventTopic = this.receivedEvent;
//var eventTopic = receivedEvent.toString;
//console.log("TOPIC: " + eventTopic);

//edit BELOW
var itemParent = "B2500V2__MQTT__intern";
var itemGroup  = "B2500V2__MQTT__intern_B2500V2__MQTT__1__";
var itemLabel  = "B2500V2 - MQTT - 1 - DATA";
//edit END

var itemGroupSUB = itemGroup + "SUB";
var itemGroupDATA = itemGroup + "DATA";

//check for GroupData and add if not exists
if (items.getItem(itemGroupDATA, true) == null) {
  //console.log("Group not found: " + itemGroupDATA);
  items.addItem({name: itemGroupDATA, type: 'Group', label: itemLabel, groups: [itemParent], tags: ['Equipment']});
}

// edit NEXT Line
var data = items.B2500V2__MQTT__intern_B2500V2__MQTT__1__SUB.state;
var response13 = false;
var response14 = false;
var response15 = false;
var response16 = false;
var response21 = false;
var response24 = false;

// check response to select/correct diz ( really dirty ) - 01/15/16 are still mixed 
if (data.startsWith("a0=") == true) { response13 = true; }
if (data.startsWith("ds=") == true) { response14 = true; }
if (data.startsWith("pe=") == true) { response15 = true; }
if (data.startsWith("p1=") == true) { if (data.length <= 100) { response16 = true; }}
if (data.startsWith("cf=") == true) { response21 = true; }
if (data.startsWith("id=") == true) { response24 = true; }

//var data = items.${itemGroupSUB}.state;
var values = data.split(',');

// gesamtleistung ein- und ausgange
var w3 = 0;
var g3 = 0;

values.forEach((value) => {
  var [key, val] = value.split('=');
  //console.log(key + ": " + val);
  
  //quick and dirty fix for double shorts ( cmd 01/13/14/16 have overlapping shorts - needs better separation ( query_short, f.ex. 1_a0 / 13_a0 / 15_a0 ))
  if ( response13 == true ) { key = "13_" + key ; }
  if ( response14 == true ) { key = "14_" + key; }
  if ( response16 == true ) {
    if (key === "e1" || key === "e2" ) { key = "16_" + key; }
  }
  if ( response21 == true ) { key = "21_" + key; }
  if ( response24 == true ) { key = "24_" + key; }
  
  var itemName = itemGroupDATA + "_" + key;
  var item = items.getItem(itemName, true);

  // create/update items
  if (item == null) {
    //console.log("Item not found: " + itemName + "(" + itemLabels[key] + ")");
    var itemType = "Number"
    if (key === "e1" || key === "f1" || key === "e2" || key === "f2" || key === "e3" || key === "f3" ) { itemType = "String"; }
    items.addItem({name: itemName, type: itemType, label: itemLabels[key], groups: [itemGroupDATA], tags: ['Point']});
  } else {
    item.postUpdate(val);
  }
  
  // gesamtleistung ein- und ausgange
  if ( key === "w1" || key === "w2") { w3 += Number(val); }
  if ( key === "g1" || key === "g2") { g3 += Number(val); }

})

// additional/calculated values
// gesamtleistung eingang
var key = "w3";
var itemName = itemGroupDATA + "_" + key;
var item = items.getItem(itemName, true);
if (item == null) {
  items.addItem({name: itemName, type: 'Number', label: itemLabels[key], groups: [itemGroupDATA], tags: ['Point']});
} else {
  item.postUpdate(w3);
}
// gesamtleistung ausgang
var key = "g3"
var itemName = itemGroupDATA + "_" + key;
var item = items.getItem(itemName, true);
if (item == null) {
  items.addItem({name: itemName, type: 'Number', label: itemLabels[key], groups: [itemGroupDATA], tags: ['Point']});
} else {
  item.postUpdate(g3);
}
// gesamtleistung eingang
var key = "last";
var timestamp = time.ZonedDateTime.now().format(time.DateTimeFormatter.ofPattern('dd.MM.yyyy HH:mm:ss'));
//console.log("Timestamp: " + timestamp);
var itemName = itemGroupDATA + "_" + key;
var item = items.getItem(itemName, true);
if (item == null) {
  items.addItem({name: itemName, type: 'String', label: itemLabels[key], groups: [itemGroupDATA], tags: ['Point']});
} else {
  item.postUpdate(timestamp);
}

